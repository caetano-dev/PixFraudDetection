
# Academic Project Context: Financial Transaction Analysis for Money Laundering Detection using Graph Methods

This is an undergraduate academic final project that involves analyzing large-scale financial transaction data to identify potential money laundering activities, focusing on the accounts. The core approach utilizes graph-based techniques applied to temporal snapshots of transaction networks and in the future will use GNNs.

***

## Data Used

The project processes transaction data from CSV files (e.g., `LI-Large_Trans.csv`, `HI-Small_Trans.csv`). Each transaction record typically includes:
* Timestamp
* From/To Bank and Account identifiers
* Amount sent/received
* Currency sent/received
* Payment Type
* A binary flag indicating if the transaction is part of a known laundering attempt (`is_laundering`).

Additionally, account details (like bank, entity ID, entity name) are loaded from separate files. Known money laundering patterns are also parsed from a text file to identify laundering attempts.

The large dataset is indeed very large, so we need to keep that in mind. Everything is being run on Google Colab, with 10GB of RAM max.

***

## Dataset Characteristics and Money Laundering Models

The dataset is generated by **AMLworld**, a synthetic data generator designed to create realistic financial transactions for anti-money laundering (AML) research. A key advantage of this synthetic dataset is its **perfect ground truth labeling**; unlike real-world data where many illicit activities go undetected, every transaction that is part of a laundering scheme is accurately flagged.

The AMLworld generator models the entire money laundering cycle, which consists of three main stages:

1.  **Placement**: The introduction of illicit funds into the financial system from criminal activities like smuggling, extortion, etc.
2.  **Layering**: The process of obscuring the origin of the illicit funds by creating complex series of transactions.
3.  **Integration**: The final stage where the laundered funds are reintroduced into the legitimate economy, for example, by paying salaries or purchasing supplies.

For the **layering stage**, the dataset specifically models eight key transaction patterns that are strong indicators of money laundering. These patterns involve a set of accounts that are all owned or controlled by the laundering entity.

The specific patterns are:

* **Fan-out**: One account sends funds to multiple other accounts.
* **Fan-in**: Multiple accounts send funds to a single account.
* **Gather-scatter**: A combination of a fan-in and a fan-out pattern centered on the same account.
* **Scatter-gather**: Funds from a source account are passed through several intermediate accounts before being consolidated into a single destination account.
* **Simple Cycle**: A series of transactions where funds start at one account and eventually return to it through other accounts.
* **Random**: A pattern similar to a cycle, but the funds do not return to the original account, instead following a random walk among controlled accounts.
* **Bipartite**: Funds are moved from one set of accounts to a different set of accounts.
* **Stack**: An extension of the bipartite pattern that adds an additional layer of accounts.

In addition to these structured patterns, the generator also models laundering that occurs more "naturally" during the **integration phase**, such as a criminal entity using illicit funds for seemingly legitimate transactions like payroll or business expenses.

This table has some additional statistics about the six datasets:

```
..                                  SMALL           MEDIUM           LARGE
..                                  HI     LI        HI      LI       HI       LI
.. Date Range HI + LI (2022)         Sep 1-10         Sep 1-16        Aug 1 - Nov 5
.. # of Days Spanned                 10     10        16      16       97       97
.. # of Bank Accounts               515K   705K     2077K   2028K    2116K    2064K
.. # of Transactions                  5M     7M       32M     31M      180M    176M
.. # of Laundering Transactions     5.1K   4.0K       35K     16K      223K    100K
.. Laundering Rate (1 per N Trans)  981   1942       905    1948       807     1750
```


***

## Preprocessing and Filtering

Raw transaction data is preprocessed using DuckDB for efficient loading and initial filtering. This involves:
* Reading large CSV files with specified column types (initially all `VARCHAR`).
* Parsing timestamps into datetime objects.
* Casting numeric fields (amounts) to `DOUBLE` and boolean flags (`is_laundering`) to `INTEGER`.
* Applying filters to select transactions based on `payment_type` (primarily 'ACH') and `currency_sent`/`currency_received` (e.g., 'US Dollar'). This filtered data is saved as Parquet files (`1_filtered_normal_transactions.parquet`, `2_filtered_laundering_transactions.parquet`).
* Account data is filtered to include only accounts involved in the selected transactions (`3_filtered_accounts.parquet`).
* There are no fees in the transactions.

Example of the filtered data:
```
Normal transactions
            timestamp from_bank from_account to_bank to_account  \
0 2022-09-01 00:17:00       011    800059120   01217  8006AD4E0   
1 2022-09-01 00:29:00     03618    800929EA0  001277  800929EF0   
2 2022-09-01 00:08:00     00394    80093BDB0  021414  80092A6C0   
3 2022-09-01 00:23:00     01231    800B69730  021414  80093CED0   
4 2022-09-01 00:19:00     02860    800BA6B40  011222  800BBE6F0   

   amount_received currency_received  amount_sent currency_sent payment_type  \
0         60562.00         US Dollar     60562.00     US Dollar          ACH   
1             0.05         US Dollar         0.05     US Dollar          ACH   
2         64335.00         US Dollar     64335.00     US Dollar          ACH   
3           217.00         US Dollar       217.00     US Dollar          ACH   
4          3400.37         US Dollar      3400.37     US Dollar          ACH   

   is_laundering  
0              0  
1              0  
2              0  
3              0  
4              0  
Laundering transactions
            timestamp from_bank from_account to_bank to_account  \
0 2022-09-03 11:23:00     01835    800F963A0    0224  801C56FF0   
1 2022-09-06 17:16:00     01835    800F963A0  022086  800CD0BE0   
2 2022-09-01 10:28:00       003    80033F3B0     011  8001DC570   
3 2022-09-02 11:51:00     01768    8007F5C20   01231  800379FA0   
4 2022-09-02 19:00:00       003    8001B8080     001  800161140   

   amount_received currency_received  amount_sent currency_sent payment_type  \
0          7648.13         US Dollar      7648.13     US Dollar          ACH   
1         18261.63         US Dollar     18261.63     US Dollar          ACH   
2          4730.57         US Dollar      4730.57     US Dollar          ACH   
3          4723.36         US Dollar      4723.36     US Dollar          ACH   
4          4070.87         US Dollar      4070.87     US Dollar          ACH   

   is_laundering  attempt_id                          attempt_type  
0              1         3.0  GATHER-SCATTER:  Max 3-degree Fan-In  
1              1         3.0  GATHER-SCATTER:  Max 3-degree Fan-In  
2              1         4.0                  RANDOM:  Max 10 hops  
3              1         4.0                  RANDOM:  Max 10 hops  
4              1         4.0                  RANDOM:  Max 10 hops  
Bank accounts
                  bank_name bank_id account_id_hex  entity_id  \
0   Fieldstone Savings Bank  311684      8054A74B0  800C891B0   
1   First Bank of Cleveland  116473      80B71CA30  8004D20A0   
2  Savings Bank of Lacrosse  325898      8096E33C0  800EA5340   
3            Greece Bank #8     600      800439AC0  800874500   
4   National Bank of Denver    8318      8044289C0  80039D5C0   

                 entity_name  
0          Corporation #7880  
1         Partnership #52150  
2         Partnership #12326  
3         Corporation #28311  
4  Sole Proprietorship #6938
```

Sample of number of nodes per day

```
LI Small

-- 3-day windows, stride=1d --
[000] 2022-09-01 → 2022-09-04: nodes=97,912, edges=98,073, pos_edges=246, pos_nodes=452
[001] 2022-09-02 → 2022-09-05: nodes=80,131, edges=72,711, pos_edges=274, pos_nodes=490
[002] 2022-09-03 → 2022-09-06: nodes=51,107, edges=52,385, pos_edges=330, pos_nodes=564
[003] 2022-09-04 → 2022-09-07: nodes=50,524, edges=64,159, pos_edges=345, pos_nodes=602
[004] 2022-09-05 → 2022-09-08: nodes=50,915, edges=76,837, pos_edges=370, pos_nodes=655
[005] 2022-09-06 → 2022-09-09: nodes=50,807, edges=77,066, pos_edges=368, pos_nodes=649
[006] 2022-09-07 → 2022-09-10: nodes=74,129, edges=92,174, pos_edges=365, pos_nodes=645
[007] 2022-09-08 → 2022-09-11: nodes=73,876, edges=79,628, pos_edges=348, pos_nodes=608
[008] 2022-09-09 → 2022-09-12: nodes=68,933, edges=53,939, pos_edges=237, pos_nodes=407
[009] 2022-09-10 → 2022-09-13: nodes=21,249, edges=13,542, pos_edges=143, pos_nodes=238
[010] 2022-09-11 → 2022-09-14: nodes=88, edges=73, pos_edges=63, pos_nodes=88
[011] 2022-09-12 → 2022-09-15: nodes=57, edges=48, pos_edges=43, pos_nodes=57
[012] 2022-09-13 → 2022-09-16: nodes=44, edges=34, pos_edges=33, pos_nodes=44
[013] 2022-09-14 → 2022-09-17: nodes=21, edges=16, pos_edges=16, pos_nodes=21
[014] 2022-09-15 → 2022-09-18: nodes=12, edges=9, pos_edges=9, pos_nodes=12
[015] 2022-09-16 → 2022-09-19: nodes=6, edges=4, pos_edges=4, pos_nodes=6

-- 7-day windows, stride=1d --
[000] 2022-09-01 → 2022-09-08: nodes=113,515, edges=188,269, pos_edges=709, pos_nodes=1,231
[001] 2022-09-02 → 2022-09-09: nodes=97,189, edges=175,269, pos_edges=782, pos_nodes=1,335
[002] 2022-09-03 → 2022-09-10: nodes=91,451, edges=169,867, pos_edges=807, pos_nodes=1,367
[003] 2022-09-04 → 2022-09-11: nodes=91,372, edges=169,824, pos_edges=811, pos_nodes=1,370
[004] 2022-09-05 → 2022-09-12: nodes=87,301, edges=156,497, pos_edges=745, pos_nodes=1,249
[005] 2022-09-06 → 2022-09-13: nodes=82,956, edges=131,024, pos_edges=620, pos_nodes=1,037
[006] 2022-09-07 → 2022-09-14: nodes=78,897, edges=105,738, pos_edges=529, pos_nodes=877
[007] 2022-09-08 → 2022-09-15: nodes=73,927, edges=79,708, pos_edges=418, pos_nodes=683
[008] 2022-09-09 → 2022-09-16: nodes=68,966, edges=53,992, pos_edges=285, pos_nodes=457
[009] 2022-09-10 → 2022-09-17: nodes=21,280, edges=13,580, pos_edges=180, pos_nodes=276
[010] 2022-09-11 → 2022-09-18: nodes=105, edges=89, pos_edges=79, pos_nodes=105
[011] 2022-09-12 → 2022-09-19: nodes=66, edges=57, pos_edges=52, pos_nodes=66
[012] 2022-09-13 → 2022-09-20: nodes=48, edges=38, pos_edges=37, pos_nodes=48
[013] 2022-09-14 → 2022-09-21: nodes=21, edges=16, pos_edges=16, pos_nodes=21
[014] 2022-09-15 → 2022-09-22: nodes=12, edges=9, pos_edges=9, pos_nodes=12
[015] 2022-09-16 → 2022-09-23: nodes=6, edges=4, pos_edges=4, pos_nodes=6

HI Small

-- 3-day windows, stride=1d --
[000] 2022-09-01 → 2022-09-04: nodes=98,303, edges=98,159, pos_edges=332, pos_nodes=581
[001] 2022-09-02 → 2022-09-05: nodes=80,543, edges=72,819, pos_edges=382, pos_nodes=646
[002] 2022-09-03 → 2022-09-06: nodes=51,467, edges=52,470, pos_edges=415, pos_nodes=671
[003] 2022-09-04 → 2022-09-07: nodes=50,932, edges=64,278, pos_edges=464, pos_nodes=743
[004] 2022-09-05 → 2022-09-08: nodes=51,307, edges=76,930, pos_edges=463, pos_nodes=748
[005] 2022-09-06 → 2022-09-09: nodes=51,225, edges=77,171, pos_edges=473, pos_nodes=780
[006] 2022-09-07 → 2022-09-10: nodes=74,531, edges=92,262, pos_edges=453, pos_nodes=738
[007] 2022-09-08 → 2022-09-11: nodes=74,377, edges=79,767, pos_edges=487, pos_nodes=800
[008] 2022-09-09 → 2022-09-12: nodes=69,376, edges=54,112, pos_edges=410, pos_nodes=645
[009] 2022-09-10 → 2022-09-13: nodes=21,588, edges=13,731, pos_edges=332, pos_nodes=490
[010] 2022-09-11 → 2022-09-14: nodes=281, edges=204, pos_edges=194, pos_nodes=264
[011] 2022-09-12 → 2022-09-15: nodes=183, edges=138, pos_edges=133, pos_nodes=174
[012] 2022-09-13 → 2022-09-16: nodes=92, edges=68, pos_edges=67, pos_nodes=90
[013] 2022-09-14 → 2022-09-17: nodes=57, edges=43, pos_edges=43, pos_nodes=57
[014] 2022-09-15 → 2022-09-18: nodes=26, edges=18, pos_edges=18, pos_nodes=26
[015] 2022-09-16 → 2022-09-19: nodes=21, edges=15, pos_edges=15, pos_nodes=21
[016] 2022-09-17 → 2022-09-20: nodes=10, edges=7, pos_edges=7, pos_nodes=10
[017] 2022-09-18 → 2022-09-21: nodes=7, edges=5, pos_edges=5, pos_nodes=7

-- 7-day windows, stride=1d --
[000] 2022-09-01 → 2022-09-08: nodes=114,555, edges=188,492, pos_edges=932, pos_nodes=1,477
[001] 2022-09-02 → 2022-09-09: nodes=98,243, edges=175,497, pos_edges=1,010, pos_nodes=1,596
[002] 2022-09-03 → 2022-09-10: nodes=92,475, edges=170,100, pos_edges=1,040, pos_nodes=1,626
[003] 2022-09-04 → 2022-09-11: nodes=92,467, edges=170,100, pos_edges=1,087, pos_nodes=1,683
[004] 2022-09-05 → 2022-09-12: nodes=88,331, edges=156,790, pos_edges=1,038, pos_nodes=1,581
[005] 2022-09-06 → 2022-09-13: nodes=83,913, edges=131,361, pos_edges=957, pos_nodes=1,432
[006] 2022-09-07 → 2022-09-14: nodes=79,686, edges=106,026, pos_edges=817, pos_nodes=1,203
[007] 2022-09-08 → 2022-09-15: nodes=74,635, edges=79,998, pos_edges=708, pos_nodes=1,045
[008] 2022-09-09 → 2022-09-16: nodes=69,530, edges=54,258, pos_edges=551, pos_nodes=794
[009] 2022-09-10 → 2022-09-17: nodes=21,667, edges=13,807, pos_edges=407, pos_nodes=568
[010] 2022-09-11 → 2022-09-18: nodes=326, edges=249, pos_edges=239, pos_nodes=309
[011] 2022-09-12 → 2022-09-19: nodes=207, edges=161, pos_edges=156, pos_nodes=198
[012] 2022-09-13 → 2022-09-20: nodes=107, edges=83, pos_edges=82, pos_nodes=105
[013] 2022-09-14 → 2022-09-21: nodes=65, edges=50, pos_edges=50, pos_nodes=65
[014] 2022-09-15 → 2022-09-22: nodes=31, edges=23, pos_edges=23, pos_nodes=31
[015] 2022-09-16 → 2022-09-23: nodes=21, edges=15, pos_edges=15, pos_nodes=21
[016] 2022-09-17 → 2022-09-24: nodes=10, edges=7, pos_edges=7, pos_nodes=10
[017] 2022-09-18 → 2022-09-25: nodes=7, edges=5, pos_edges=5, pos_nodes=7

LI Large

(sample)

Loaded: 7,267,159 tx; accounts: 539,648

-- 3-day windows, stride=1d --
[000] 2022-08-01 → 2022-08-04: nodes=207,640, edges=267,125, pos_edges=547, pos_nodes=1,076
[001] 2022-08-02 → 2022-08-05: nodes=151,212, edges=228,848, pos_edges=575, pos_nodes=1,130
[002] 2022-08-03 → 2022-08-06: nodes=235,965, edges=288,320, pos_edges=609, pos_nodes=1,205
[003] 2022-08-04 → 2022-08-07: nodes=235,245, edges=251,421, pos_edges=625, pos_nodes=1,239
[004] 2022-08-05 → 2022-08-08: nodes=234,675, edges=214,420, pos_edges=588, pos_nodes=1,162
[005] 2022-08-06 → 2022-08-09: nodes=149,821, edges=154,504, pos_edges=573, pos_nodes=1,132
[006] 2022-08-07 → 2022-08-10: nodes=149,993, edges=191,251, pos_edges=552, pos_nodes=1,093
[007] 2022-08-08 → 2022-08-11: nodes=149,909, edges=227,415, pos_edges=585, pos_nodes=1,152

-- 7-day windows, stride=1d --
[000] 2022-08-01 → 2022-08-08: nodes=333,688, edges=557,764, pos_edges=1,339, pos_nodes=2,607
[001] 2022-08-02 → 2022-08-09: nodes=285,980, edges=519,419, pos_edges=1,360, pos_nodes=2,634
[002] 2022-08-03 → 2022-08-10: nodes=285,537, edges=518,706, pos_edges=1,370, pos_nodes=2,665
[003] 2022-08-04 → 2022-08-11: nodes=284,772, edges=518,054, pos_edges=1,377, pos_nodes=2,684
[004] 2022-08-05 → 2022-08-12: nodes=283,307, edges=516,371, pos_edges=1,375, pos_nodes=2,668
[005] 2022-08-06 → 2022-08-13: nodes=266,298, edges=499,356, pos_edges=1,382, pos_nodes=2,679
[006] 2022-08-07 → 2022-08-14: nodes=266,184, edges=500,034, pos_edges=1,392, pos_nodes=2,689
[007] 2022-08-08 → 2022-08-15: nodes=266,516, edges=499,767, pos_edges=1,427, pos_nodes=2,758

HI Large

(sample)

Loaded: 7,236,519 tx; accounts: 555,586

-- 3-day windows, stride=1d --
[000] 2022-08-01 → 2022-08-04: nodes=205,495, edges=262,907, pos_edges=756, pos_nodes=1,418
[001] 2022-08-02 → 2022-08-05: nodes=149,252, edges=225,315, pos_edges=820, pos_nodes=1,543
[002] 2022-08-03 → 2022-08-06: nodes=233,455, edges=284,687, pos_edges=903, pos_nodes=1,694
[003] 2022-08-04 → 2022-08-07: nodes=233,562, edges=248,901, pos_edges=933, pos_nodes=1,708
[004] 2022-08-05 → 2022-08-08: nodes=233,430, edges=213,262, pos_edges=953, pos_nodes=1,725
[005] 2022-08-06 → 2022-08-09: nodes=149,488, edges=154,169, pos_edges=956, pos_nodes=1,723
[006] 2022-08-07 → 2022-08-10: nodes=149,856, edges=190,405, pos_edges=1,031, pos_nodes=1,876
[007] 2022-08-08 → 2022-08-11: nodes=149,365, edges=225,845, pos_edges=1,101, pos_nodes=1,993

-- 7-day windows, stride=1d --
[000] 2022-08-01 → 2022-08-08: nodes=330,720, edges=551,335, pos_edges=2,022, pos_nodes=3,587
[001] 2022-08-02 → 2022-08-09: nodes=283,562, edges=514,176, pos_edges=2,096, pos_nodes=3,684
[002] 2022-08-03 → 2022-08-10: nodes=283,948, edges=514,135, pos_edges=2,234, pos_nodes=3,908
[003] 2022-08-04 → 2022-08-11: nodes=283,829, edges=514,273, pos_edges=2,367, pos_nodes=4,090
[004] 2022-08-05 → 2022-08-12: nodes=283,547, edges=514,650, pos_edges=2,464, pos_nodes=4,228
[005] 2022-08-06 → 2022-08-13: nodes=267,438, edges=498,876, pos_edges=2,588, pos_nodes=4,422
[006] 2022-08-07 → 2022-08-14: nodes=268,065, edges=499,426, pos_edges=2,740, pos_nodes=4,678
[007] 2022-08-08 → 2022-08-15: nodes=268,287, edges=499,523, pos_edges=2,892, pos_nodes=4,901
```

***

## Graph Construction

For analysis, the filtered transaction data is transformed into a graph representation using graph-tool, igraph, and leidenalg. This process involves:

    Aggregating transactions within defined temporal windows (e.g., 3-day, 7-day windows with a 1-day stride).

    Creating nodes representing financial accounts.

    Creating edges between accounts if a transaction occurred between them within the window.

    Aggregating edge properties: w_count (number of transactions), w_amount (sum of received amounts in cents), and w_amount_log (log-scaled received amount).

    Adding vertex properties: name (account ID), bank_id, entity_id, and is_laundering_involved.

    Computing vertex-level aggregate properties: in_amount_sum, out_amount_sum, in_deg, out_deg, in_tx_count, out_tx_count.

Both directed and undirected graphs are constructed. For now, the focus is on graph analysis without AI, but GNNs will be implemented in the future.

***

## Graph Analysis Methods

Several graph-based techniques are applied within each time window:

    Centrality Baselines: Standard node centrality measures including PageRank, HITS, in/out degree, and transaction counts/amounts.

    K-Core: Computes the coreness of nodes in both directed and undirected graphs.

    Personalized PageRank (PPR): Run on the directed graph using known laundering accounts from an earlier time period as seeds to avoid look-ahead bias.

    Pattern-Based Features: A custom scoring model that combines several structural heuristics to identify nodes participating in common laundering patterns. It considers metrics like fan-in/fan-out ratios, local subgraph tree-likeness (for scatter-gather patterns), hub scores, and transaction velocity.

    Ensemble Methods: Combines multiple individual scores (e.g., PageRank, in-degree, pattern features) using weighted averages to create more robust composite scores like ensemble_ultimate and ensemble_seeded.

    Community Detection: The Louvain and Leiden algorithms are applied to the undirected graph. The system performs a detailed comparative analysis of the top communities from each method, evaluating their size, density, laundering node percentage, financial volume, and entity/bank diversity. Specific communities can be exported to GraphML for visual analysis.
***

## Hyperparameter Optimization & Automation

A significant part of the project is dedicated to automating experimentation and finding the best model parameters.

    Batch Processing Framework: A high-level function (run_batch_analysis) automates the entire analysis pipeline across multiple datasets (e.g., LI_Large, HI_Small) and all specified currencies. It handles directory checks, error handling, and generates a final summary report.

    Automated Parameter Recommendation: A diagnostics script (analyze_dataset_characteristics) performs an initial analysis of a dataset's temporal patterns, graph density, and laundering attempt structures. Based on this, it provides data-driven recommendations for key hyperparameters like window_days, ppr_alpha, ppr_hops, and leiden_resolution.

    Configuration Comparison: The framework supports running multiple experiments with different parameters. A dedicated script then loads the results from these runs, systematically compares their performance (e.g., median Average Precision), and generates summary tables and visualizations to identify the single best combination of methods and hyperparameters.

## Evaluation

The performance of different scoring methods in identifying laundering accounts is evaluated within each time window:

    Metrics: Average Precision (AP), Precision@K (e.g., p_at_1.0pct), and Lift over Baseline (Precision@K / prevalence) are calculated.

    Attempt Coverage: A custom metric (attcov_at_Kpct) measures the fraction of known laundering attempts that are identified by the top K% of ranked accounts or communities.

    Heuristic Community Scoring: Communities are scored based on a combination of structural properties including tree-likeness, sparsity, hub-soreness, and total amount, with a size boost factor to identify suspicious clusters.

    Baselines: A random baseline is included for comparison.

    Results Storage: Per-window metrics are saved to a CSV file (window_metrics.csv). A summary of median metrics across all windows is also generated.

***

## Diagnostics

Additional diagnostic steps are performed to understand the nature of the raw data and the impact of filtering:
* Analysis of daily counts and prevalence of normal vs. laundering transactions in the raw data.
* Investigation of payment types and currency combinations present in normal transactions after a specific date cutoff.
* Comparison of transaction counts under strict filtering vs. more relaxed criteria (e.g., including other payment types, or filtering by currency on either leg of the transaction).

***

## Overall Goal

The project aims to assess the effectiveness of various graph-based features and community structures in identifying known money laundering activities within dynamic transaction networks. It seeks to provide insights into which methods perform best under different data conditions and compare them to a future GNN-based approach.